<section class="document">
  @if (loading()) {
  } @else if (document()) {
    <header class="document__header">
      <div class="document__header-column">
        <nav class="document__navigation">
          <fq-button variant="text" (onClick)="goBack()">
            <svg width="8" height="14" viewBox="0 0 8 14" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path fill-rule="evenodd" clip-rule="evenodd" d="M7.70711 0.292893C8.09763 0.683417 8.09763 1.31658 7.70711 1.70711L2.41421 7L7.70711 12.2929C8.09763 12.6834 8.09763 13.3166 7.70711 13.7071C7.31658 14.0976 6.68342 14.0976 6.29289 13.7071L0.292893 7.70711C-0.0976311 7.31658 -0.0976311 6.68342 0.292893 6.29289L6.29289 0.292893C6.68342 -0.0976311 7.31658 -0.0976311 7.70711 0.292893Z" fill="black"/>
            </svg>
            Назад к результатам поиска
          </fq-button>
          <fq-button variant="text" (onClick)="toRelated()">
            Связанные документы
            <svg width="8" height="14" viewBox="0 0 8 14" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path fill-rule="evenodd" clip-rule="evenodd" d="M0.292893 13.7071C-0.0976315 13.3166 -0.0976315 12.6834 0.292893 12.2929L5.58579 7L0.292893 1.70711C-0.0976315 1.31658 -0.0976315 0.683417 0.292893 0.292893C0.683417 -0.0976315 1.31658 -0.0976315 1.70711 0.292893L7.70711 6.29289C8.09763 6.68342 8.09763 7.31658 7.70711 7.70711L1.70711 13.7071C1.31658 14.0976 0.683417 14.0976 0.292893 13.7071Z" fill="black"/>
            </svg>
          </fq-button>
        </nav>
        <div class="document__title-wrapper">
          <h1 class="document__title">{{ (document()?.title | underscore) ?? 'Без названия' }}</h1>
          <fq-badge class="document__badge">{{ getFileExtension(document()?.file_name || '') }}</fq-badge>
          <fq-badge
            class="document__badge"
            [variant]="document()?.is_actual ? 'success' : 'error'"
          >
            {{ document()?.is_actual ? 'Актуальный' : 'Архивный' }}
          </fq-badge>
        </div>
        <div class="document__header-controls">
          <fq-button>
            Редактировать
          </fq-button>
          <fq-button variant="outline" (onClick)="onAddToCollectionClick()">
            Добавить в подборку
          </fq-button>
        </div>
      </div>
      <fq-card as="aside" class="document__info-card info-card">
        <h2 class="info-card__title">Информация о документе</h2>
        <div class="info-card__wrapper">
          <dl class="info-card__list">
            <div class="info-card__item">
              <dt class="info-card__term">Добавление</dt>
              <dd class="info-card__definition">{{ document()?.upload_date | date:'dd.MM.yyyy HH:mm' }} ({{ document()?.uploaded_by ?? 'Не указан' }})</dd>
            </div>
            <div class="info-card__item">
              <dt class="info-card__term">Департамент</dt>
              <dd class="info-card__definition">{{ document()?.department_name ?? 'Не указан' }}</dd>
            </div>
            <div class="info-card__item">
              <dt class="info-card__term">Версия</dt>
              <dd class="info-card__definition">{{ document()?.version_id?.slice(0, 8) || 'Не указана' }}</dd>
            </div>
          </dl>

          <div class="info-card__footer">
            <fq-button variant="text" class="info-card__text-button">История изменений</fq-button>
          </div>
        </div>
      </fq-card>
    </header>

    <div class="document__controls controls">
      @if (isPdfDocument()) {
        <div class="controls__group">
          <fq-button variant="outline" shape="circle" (onClick)="zoomOut()" aria-label="Уменьшить масштаб">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M7 10H13M15 15L21 21M10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10C17 13.866 13.866 17 10 17Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </fq-button>
          <span class="controls__value">{{ zoom() * 100 | number:'1.0-0' }}%</span>
          <fq-button variant="outline" shape="circle" (onClick)="zoomIn()" aria-label="Увеличить масштаб">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M7 10H10M10 10H13M10 10V7M10 10V13M15 15L21 21M10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10C17 13.866 13.866 17 10 17Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </fq-button>
        </div>

        @if (totalPages() > 1) {
          <div class="controls__group">
            <fq-button variant="outline" shape="circle" (onClick)="prevPage()" [disabled]="page() <= 1" aria-label="Предыдущая страница">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M15 19L8 12L15 5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </fq-button>
            <span class="controls__value">{{ page() }} / {{ totalPages() }}</span>
            <fq-button variant="outline" shape="circle" (onClick)="nextPage()" [disabled]="page() >= totalPages()" aria-label="Следующая страница">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M9 5L16 12L9 19" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </fq-button>
          </div>
        }
      } @else if (isHtmlDocument()) {
        <div class="controls__group">
          <fq-button variant="outline" shape="circle" (onClick)="zoomOut()" aria-label="Уменьшить масштаб">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M7 10H13M15 15L21 21M10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10C17 13.866 13.866 17 10 17Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </fq-button>
          <span class="controls__value">{{ htmlZoom() * 100 | number:'1.0-0' }}%</span>
          <fq-button variant="outline" shape="circle" (onClick)="zoomIn()" aria-label="Увеличить масштаб">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M7 10H10M10 10H13M10 10V7M10 10V13M15 15L21 21M10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10C17 13.866 13.866 17 10 17Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </fq-button>
        </div>
      }

      <fq-button
        shape="circle"
        (click)="downloadDocument()"
        [loading]="downloading()"
        aria-label="Скачать документ"
      >
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 12V18M12 18L15 16M12 18L9 16M13 3.00087C12.9045 3 12.7973 3 12.6747 3H8.2002C7.08009 3 6.51962 3 6.0918 3.21799C5.71547 3.40973 5.40973 3.71547 5.21799 4.0918C5 4.51962 5 5.08009 5 6.2002V17.8002C5 18.9203 5 19.4801 5.21799 19.9079C5.40973 20.2842 5.71547 20.5905 6.0918 20.7822C6.5192 21 7.07899 21 8.19691 21H15.8031C16.921 21 17.48 21 17.9074 20.7822C18.2837 20.5905 18.5905 20.2842 18.7822 19.9079C19 19.4805 19 18.9215 19 17.8036V9.32568C19 9.20296 19 9.09561 18.9991 9M13 3.00087C13.2856 3.00347 13.4663 3.01385 13.6388 3.05526C13.8429 3.10425 14.0379 3.18526 14.2168 3.29492C14.4186 3.41857 14.5918 3.59182 14.9375 3.9375L18.063 7.06298C18.4089 7.40889 18.5809 7.58136 18.7046 7.78319C18.8142 7.96214 18.8953 8.15726 18.9443 8.36133C18.9857 8.53376 18.9963 8.71451 18.9991 9M13 3.00087V5.8C13 6.9201 13 7.47977 13.218 7.90759C13.4097 8.28392 13.7155 8.59048 14.0918 8.78223C14.5192 9 15.079 9 16.1969 9H18.9991M18.9991 9H19.0002" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </fq-button>
    </div>

    <div class="document__preview" (mouseup)="onTextSelection()" (copy)="onCopy($event)">
      @if (isPdfDocument()) {
        <pdf-viewer
          [src]="safePreviewUrl()"
          [render-text]="true"
          [original-size]="false"
          [show-all]="zoom() < 1"
          [page]="page()"
          [zoom]="zoom()"
          (after-load-complete)="onPdfLoaded($event)"
          style="width: 100%; height: 100%;">
        </pdf-viewer>
      } @else if (isHtmlDocument()) {
        <div class="html-preview-wrapper"
             [class.html-preview-wrapper--scroll]="htmlZoom() > 1">
          <div
            class="html-preview-content"
            [style.transform]="'scale(' + htmlZoom() + ')'"
            [style.transform-origin]="'top left'"
            [style.width]="htmlZoom() > 1 ? 100 * htmlZoom() + '%' : '100%'"
            [style.height]="htmlZoom() > 1 ? 100 * htmlZoom() + '%' : '100%'"
          >
            <iframe
              [src]="safeHtmlUrl()"
              class="html-preview__iframe"
              sandbox="allow-same-origin allow-scripts"
              (load)="onIframeLoad($event)"
            ></iframe>
          </div>
        </div>
      }
    </div>

    @if (showSelectionToolbar() && selectedText()) {
      <div
        class="selection-toolbar"
        [style.left.px]="selectionPosition().x"
        [style.top.px]="selectionPosition().y"
      >
        <div class="selection-toolbar__content">
          <fq-button
            variant="text"
            size="small"
            (click)="onAddToFavorites()"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
            </svg>
            В избранное
          </fq-button>

          <fq-button
            variant="text"
            size="small"
            (click)="onAddComment()"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
            </svg>
            Комментарий
          </fq-button>

          <fq-button
            variant="text"
            size="small"
            (click)="showSelectionToolbar.set(false)"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
            </svg>
          </fq-button>
        </div>
      </div>
    }
  }
</section>
<app-add-to-collection-dialog
  [open]="showAddToCollectionDialog()"
  [documentId]="document()?.document_id || ''"
  [saving]="addingToCollection()"
  (save)="onAddToCollection($event)"
  (closed)="onAddToCollectionDialogClosed()"
></app-add-to-collection-dialog>
